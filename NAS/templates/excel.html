<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">      <!--设置编码集-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">   <!--设置如果是edge浏览器就以最高规格渲染页面-->
    <meta name="viewport" content="width=device-width, initial-scale=1">    <!--设置页面宽度随设备宽度进行一比一缩放-->
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <title>excel文件预览</title>
    <style>
        *{
            font-size: 16px;
        }
        h1{
            text-align: center;
        }
        tr{
            vertical-align: middle;
            min-height: 60px!important;
        }
        td{
            min-width: 80px;
            min-height: 40px;
            text-align: center;
            vertical-align: middle!important;
        }
    </style>
</head>
<body>
    {{ html|safe }}
</body>

<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="/static/js/jQuery.js"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="/static/js/bootstrap.min.js"></script>
<script>
    window.onload = function () {
        console.log('加载完毕');
        let row_merged_dict = {{ row_merged_dict|safe }};
        let col_merged_dict = {{ col_merged_dict|safe }};
        row_merged(row_merged_dict);
        col_merged(col_merged_dict);
        rm_col_span(col_merged_dict);
        rm_row_span(row_merged_dict);
        function col_merged(col_merged_dict) {
            for (let key in col_merged_dict){
            let sheet_table = document.querySelector(`.${key}`);
            let tr_list = sheet_table.querySelectorAll('tr');
            for (let index in col_merged_dict[key]){
                let val_list = col_merged_dict[key][index];
                for (let col in val_list){
                    col = parseInt(col);
                    let span_row = val_list[col][0];
                    let td_list = tr_list[span_row - 1].querySelectorAll("td");
                    let row_span_td = td_list[col - 1];
                    row_span_td.setAttribute(`rowspan`, val_list[col][1] - val_list[col][0] + 1);
                }
            }
        }
        }
        function rm_col_span(row_merged_dict){
            for (let key in col_merged_dict){
                let sheet_table = document.querySelector(`.${key}`);
                let tr_list = sheet_table.querySelectorAll('tr');
                for (let index in col_merged_dict[key].reverse()){
                    let val_list = col_merged_dict[key][index];
                    for (let col in val_list){
                        for (let i=parseInt(val_list[col][0]);i<parseInt(val_list[col][1]);i++){
                            let rm_col = parseInt(col) -1
                            let td_list = tr_list[i].querySelectorAll("td");
                            let td = td_list[rm_col];
                            tr_list[i].removeChild(td);
                         }
                    }
                }
            }
        }
        function row_merged(row_merged_dict) {
            for (let key in row_merged_dict){
                let sheet_table = document.querySelector(`.${key}`);
                let tr_list = sheet_table.querySelectorAll('tr');
                let row_count = {}
                for (let index in row_merged_dict[key]){
                    let val_list = row_merged_dict[key][index];
                    for (let row in val_list) {
                        let count = row_count[row]?row_count[row]:0;
                        row_count[row] = count += 1;
                        row = parseInt(row);
                        let span_col = val_list[row][0];
                        let td_list = tr_list[row - 1].querySelectorAll("td");
                        let col_span_td = td_list[span_col - 1];
                        col_span_td.setAttribute(`colspan`, val_list[row][1] - val_list[row][0] + 1)
                    }
                }
            }
        }
        function rm_row_span(row_merged_dict) {
            for (let key in row_merged_dict){
                let sheet_table = document.querySelector(`.${key}`);
                let tr_list = sheet_table.querySelectorAll('tr');
                for (let index in row_merged_dict[key].reverse()) {
                    let val_list = row_merged_dict[key][index];
                    for (let row in val_list){
                        for (let i=parseInt(val_list[row][1]);i>parseInt(val_list[row][0]);i--){
                            let rm_col = parseInt(i) -1
                            let td_list = tr_list[row-1].querySelectorAll("td");
                            let td = td_list[rm_col];
                            tr_list[row - 1].removeChild(td);
                         }
                    }
                 }
            }
        }
    }
</script>
</html>